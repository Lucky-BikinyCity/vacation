<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그룹</title>
    <link rel="stylesheet" href="../src/index.css">
    <style>
        .active {
            filter: opacity(0.7);
        }
    </style>
</head>
<body id="groupBody">
    <header class="groupHtmlHeader">
        <img src="../imgs/web-icons/logo2-B.png" alt="Logo" class="logo logoInMain" onclick="location.href='./main.html';">
        <div class="profileWrapper">
            <div class="profileNameWrapper">
                <img src="../imgs/icon/user_circle.png" class="profileImg" alt="">
                <span id="profileName" class="profileName"></span>
            </div>
            <div class="profileInfo">
                <div class="containerInProfileInfo">
                    <img src="../imgs/icon/group-B.png" alt="">
                    <div>그룹</div>
                    <div></div>
                    <span id="group_count" class="count"></span>
                </div>

                <div class="containerInProfileInfo">
                    <img src="../imgs/icon/heart_fill.png" alt="">
                    <div>좋아요</div>
                    <div></div>
                    <span id="like_count" class="count"></span>
                </div>
                <hr>
                <button id="reviseProfile" class="containerInProfileInfo">
                    <img src="../imgs/icon/setting.png" alt="">
                    <div>프로필 수정</div>
                </button>

                <button id="logout" class="logoutInProfile">
                    <img src="../imgs/icon/exit-b.png" alt="">
                    로그아웃
                </button>
            </div>
        </div>
    </header>

    <div class="secondGroupBody">
        <div id="sidebar" class="sidebar">
            <img id="closeSidebar" src="../imgs/icon/close.png" alt="">
            <div class="titleContainer">TITLE</div>
            <div class="memberListContainer"></div>

            <div class="hideMemberList"></div> <!--단순히 멤버리스트 가리기 용-->
            <div class="addUserContainer">
                <div id="searchUserContainer" class="searchUserContainer">
                    <div class="inputContainer">
                        <input id="searchUser" class="searchUser" type="text" placeholder="유저 검색">
                        <button class="searchButton" onclick="searchUser()"><img src="../imgs/icon/search.png" alt=""></button>
                    </div>
                    <div class="searchResultContainer">
                        <div class="searchResult" onclick="inviteUser()">
                            <img class="searchResultImg" src="../imgs/icon/user.png" alt="">
                            <div id="searchName" class="searchName"></div>
                        </div>
                    </div>
                </div>
                <button id="addmember" class="addMember"><img src="../imgs/icon/add-user.png" alt=""></button>
            </div>
        </div>

        <button id="buttonSidebar" class="buttonSidebar"><img src="../imgs/icon/menu.png" alt=""></button>

        <!--노션 링크 틀-->
        <!-- <div id="postWrite" class="postWrite">
            <div class="postContainer">
                <div id="postUnderlineOfTitle" class="postUnderlineOfTitle">
                    <img src="../imgs/icon/title.png" alt="">
                    <input type="text" id="title" placeholder="title of notion" class="embedLink">
                </div>
                <div class="postUnderline">
                    <img src="../imgs/icon/link.png" alt="">
                    <input type="text" id="embedLink" placeholder="your blog or notion link..." class="embedLink">
                </div>
                <div class="chooseLink">
                    <button id="blogBtn" class="blogBtn"><img src="../imgs/icon/blog.png" alt=""></button>
                    <button id="notionBtn" class="notionBtn"><img src="../imgs/icon/notion.png" alt=""></button>
                </div>
                <button id="submitPost" class="submitPost" type="submit">Post</button>
            </div>
        </div> -->

        <!--블로그 링크 틀-->
        <!-- <div id="postWrite" class="postWrite">
            <div class="postContainer2">
                <div class="postUnderline">
                    <img src="../imgs/icon/link.png" alt="">
                    <input type="text" id="embedLink" placeholder="your blog or notion link..." class="embedLink">
                </div>
                <div class="chooseLink">
                    <button id="blogBtn" class="blogBtn"><img src="../imgs/icon/blog.png" alt=""></button>
                    <button id="notionBtn" class="notionBtn"><img src="../imgs/icon/notion.png" alt=""></button>
                </div>
                <button id="submitPost" class="submitPost" type="submit">Post</button>
            </div>
        </div> -->

        <div id="groupContainer" class="groupContainer">

        </div>
    </div>
</body>
<script>
document.addEventListener('DOMContentLoaded', function(){
    GroupBody();
});

function GroupBody(){
    openSearchUser();
    SidebarOnOff();
    ShowProfile();
    fetchGroupInfo(); // 그룹 정보를 불러옴
}

let currentUserID = '';
let groupOwnerID = '';
let groupID = '';

async function fetchGroupInfo() {
    try {
        const response = await fetch('/api/group-info');
        if (!response.ok) {
            throw new Error('Failed to fetch group info');
        }
        const data = await response.json();
        groupID = data.groupID;
        renderGroupInfo(data);
        loadPosts(); // 그룹 정보를 가져온 후 게시글 로드
    } catch (error) {
        console.error('Error fetching group info:', error);
    }
}

function renderGroupInfo(data) {
    const memberListContainer = document.querySelector('.memberListContainer');
    memberListContainer.innerHTML = '';

    const titleContainer = document.querySelector('.titleContainer');
    titleContainer.textContent = data.groupName; // 그룹 이름 출력

    const { currentUser, groupOwner, members } = data;
    currentUserID = currentUser.user_ID;
    groupOwnerID = groupOwner.user_ID;

    // 현재 사용자와 그룹장이 동일한 경우
    if (currentUser.user_ID === groupOwner.user_ID) {
        const currentUserElement = document.createElement('div');
        currentUserElement.className = 'memberList';
        currentUserElement.innerHTML = `
            <img src="../imgs/icon/captain.png" alt="">
            <div class="member">
                <span id="myname">${currentUser.user_name}</span>
                <div>(나)</div>
            </div>
            <button id="openPost" onclick="postOnOff()"><img src="../imgs/icon/post.png" alt=""></button>
        `;
        memberListContainer.appendChild(currentUserElement);
    } else {
        // 현재 사용자
        const currentUserElement = document.createElement('div');
        currentUserElement.className = 'memberList';
        currentUserElement.innerHTML = `
            <img src="../imgs/icon/user.png" alt="">
            <div class="member">
                <span id="myname">${currentUser.user_name}</span>
                <div>(나)</div>
            </div>
            <button id="openPost" onclick="postOnOff()"><img src="../imgs/icon/post.png" alt=""></button>
        `;
        memberListContainer.appendChild(currentUserElement);

        // 그룹장
        const groupOwnerElement = document.createElement('div');
        groupOwnerElement.className = 'memberList';
        groupOwnerElement.innerHTML = `
            <img src="../imgs/icon/captain.png" alt="">
            <span id="membername" class="member">${groupOwner.user_name}</span>
        `;
        memberListContainer.appendChild(groupOwnerElement);
    }

    // 다른 멤버들
    members.forEach(member => {
        if (member.user_ID !== currentUser.user_ID && member.user_ID !== groupOwner.user_ID) {
            const memberElement = document.createElement('div');
            memberElement.className = 'memberList';
            memberElement.innerHTML = `
                <img src="../imgs/icon/user.png" alt="">
                <span id="membername" class="member">${member.user_name}</span>
                ${groupOwnerID === currentUserID ? `<button class="kickButton" onclick="kickUser('${member.user_ID}')"><img src="../imgs/icon/close.png" alt=""></button>` : ''}
            `;
            memberElement.addEventListener('click', () => {
                filterPostsByUser(member.user_ID);
            });
            memberListContainer.appendChild(memberElement);
        }
    });

    titleContainer.addEventListener('click', () => {
        loadPosts();
    });
}

function filterPostsByUser(userID) {
    fetch(`/api/group-posts?group_ID=${groupID}&user_ID=${userID}`)
        .then(response => response.json())
        .then(posts => {
            renderPosts(posts);
        })
        .catch(error => {
            console.error('Error fetching posts:', error);
        });
}

async function kickUser(userID) {
    try {
        const response = await fetch('/api/kick-user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_ID: userID, group_ID: groupID, groupOwnerID: groupOwnerID })
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            fetchGroupInfo();
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function searchUser() {
    const userID = document.getElementById('searchUser').value;
    const searchName = document.getElementById('searchName');

    console.log('Searching for user:', userID);

    try {
        const response = await fetch('/api/search-user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_ID: userID })
        });

        const result = await response.json();

        if (response.ok) {
            searchName.textContent = `${result.user_name} (${result.user_ID})`;
            document.querySelector('.searchResultContainer').style.display = 'block';
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function inviteUser() {
    const searchName = document.getElementById('searchName').textContent;
    const userID = searchName.split('(')[1].slice(0, -1);

    console.log('Inviting user:', userID);

    try {
        const response = await fetch('/api/invite-user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_ID: userID })
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            fetchGroupInfo();
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function formatDateForMySQL(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    const seconds = String(d.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    const year = String(date.getFullYear()).slice(2);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
}

async function submitPost() {
    const embedLink = document.getElementById("embedLink").value;
    let postType = '';
    
    if (blogBtn.classList.contains("active")) {
        postType = 'blog';
    } else if (notionBtn.classList.contains("active")) {
        postType = 'notion';
    }

    const postData = {
        link: embedLink,
        posting_time: formatDateForMySQL(new Date()), // 날짜를 MySQL 형식으로 변환
        group_ID: groupID,
        user_ID: currentUserID,
        post_type: postType
    };

    console.log('Submitting post:', postData);

    try {
        const response = await fetch('/api/submit-post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            location.reload(); // 페이지 새로고침
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadPosts() {
    try {
        const response = await fetch(`/api/group-posts?group_ID=${groupID}`);
        if (!response.ok) {
            throw new Error('Failed to fetch posts');
        }
        const posts = await response.json();
        renderPosts(posts);
    } catch (error) {
        console.error('Error fetching posts:', error);
    }
}

async function checkLike(postID) {
    try {
        const response = await fetch(`/api/check-like?post_ID=${postID}&user_ID=${currentUserID}`); // user_ID 추가
        if (!response.ok) {
            throw new Error('Failed to check like');
        }
        const result = await response.json();
        return result.liked;
    } catch (error) {
        console.error('Error checking like:', error);
        return false;
    }
}

function renderPosts(posts) {
    const groupContainer = document.getElementById('groupContainer');
    groupContainer.innerHTML = '';

    posts.forEach(async (post) => {
        const postElement = document.createElement('div');
        postElement.className = 'boardContainer';

        let postContent;
        if (post.post_type === 'blog') {
            postContent = `<iframe class="board" src="${post.link}" frameborder="0"></iframe>`;
        } else if (post.post_type === 'notion') {
            postContent = ` <div class="board" style="cursor:pointer;" onclick="location.href='${post.link}';">
                                <div>
                                    <img class="imgInBoard" src="../imgs/icon/notion.png">
                                    <span>타이틀</span>
                                </div>
                            </div>`;
        }

        const liked = await checkLike(post.post_ID);
        const likeIcon = liked ? 'heart_fill_red.png' : 'heart.png';

        postElement.innerHTML = `
            ${postContent}
            <div class="commentContainer">
                ${currentUserID === post.user_ID ? `<button onclick="deletePost('${post.post_ID}')" id="delPost" class="delPost"><img src="../imgs/icon/delete.png" alt="Delete"></button>` : ''}
                <div class="commentList" id="commentList-${post.post_ID}"></div>
                <div class="commentFooter">
                    <button id="like-${post.post_ID}" class="like btnCommentFooter" onclick="toggleLike('${post.post_ID}')"><img src="../imgs/icon/${likeIcon}" alt="Like"></button>
                    <img class="commentImg imgInComment" src="../imgs/icon/comment.png" alt="">
                    <div class="commentStructure">
                        <input id="commentInput-${post.post_ID}" class="commentInput" type="text" placeholder="댓글">
                        <button onclick="submitComment('${post.post_ID}')" class="sendComment btnCommentFooter"><img src="../imgs/icon/send.png" alt=""></button>
                    </div>
                </div>
            </div>
        `;

        groupContainer.appendChild(postElement);
        loadComments(post.post_ID); // 댓글 로드
    });
}

async function deletePost(postID) {
    try {
        const response = await fetch('/api/delete-post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ post_ID: postID })
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            loadPosts(); // 게시글 삭제 후 게시글 리스트를 다시 로드합니다.
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadComments(postID) {
    try {
        const response = await fetch(`/api/post-comments?post_ID=${postID}`);
        if (!response.ok) {
            throw new Error('Failed to fetch comments');
        }
        const comments = await response.json();
        renderComments(postID, comments);
    } catch (error) {
        console.error('Error fetching comments:', error);
    }
}

function renderComments(postID, comments) {
    const commentList = document.getElementById(`commentList-${postID}`);
    commentList.innerHTML = '';

    comments.forEach(comment => {
        const formattedTime = formatDateTime(comment.posting_time);
        const commentElement = document.createElement('div');
        commentElement.className = 'comment';
        commentElement.innerHTML = `
            <div class="commentHeader">
                <div class="commentWriter">${comment.user_ID}</div>
                <div class="commentPostDate">${formattedTime}</div>
            </div>
            <div class="commentContent">${comment.content}</div>
            ${currentUserID === comment.user_ID ? `<button onclick="deleteComment(${comment.comment_ID}, ${postID})" class="delComment">[삭제]</button>` : ''}
        `;
        commentList.appendChild(commentElement);
    });
}

async function submitComment(postID) {
    const commentInput = document.getElementById(`commentInput-${postID}`);
    const content = commentInput.value;

    const commentData = {
        post_ID: postID,
        user_ID: currentUserID,
        content: content,
        posting_time: formatDateForMySQL(new Date())
    };

    console.log('Submitting comment:', commentData);

    try {
        const response = await fetch('/api/submit-comment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(commentData)
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            location.reload(); // 페이지 새로고침
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function deleteComment(commentID, postID) {
    try {
        const response = await fetch('/api/delete-comment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ comment_ID: commentID })
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            loadComments(postID); // 댓글 삭제 후 댓글 리스트를 다시 로드합니다.
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function toggleLike(postID) {
    try {
        const response = await fetch('/api/toggle-like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_ID: currentUserID, post_ID: postID })
        });

        const result = await response.json();

        if (response.ok) {
            const likeButton = document.getElementById(`like-${postID}`);
            const likeIcon = result.liked ? 'heart_fill_red.png' : 'heart.png';
            likeButton.innerHTML = `<img src="../imgs/icon/${likeIcon}" alt="Like">`;

            // 좋아요 토글 후 사용자 정보 갱신
            await fetchUserInfo();
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

window.onload = async function() {
    await fetchUserInfo();
    fetchGroupInfo();
};

async function fetchUserInfo() {
    try {
        const response = await fetch('/api/main');
        if (!response.ok) {
            throw new Error('사용자 정보를 가져오지 못했습니다.');
        }
        const data = await response.json();
        document.getElementById('profileName').textContent = data.user_name;
        document.getElementById('group_count').textContent = data.group_count;
        document.getElementById('like_count').textContent = data.like_count;
    } catch (error) {
        console.error('Error fetching user info:', error);
    }
}

document.getElementById('submitPost').addEventListener('click', submitPost);

function openSearchUser() {
    var check = false;
    const searchUser = document.querySelector('.searchUserContainer');
    const searchResult = document.querySelector('.searchResultContainer');

    document.getElementById('addmember').addEventListener('click', function() {
        if (check) {
            searchUser.style.height = '0';
            searchResult.style.display = 'none';
            check = false;
        } else {
            searchUser.style.height = '260px';
            setTimeout(() => {
                searchResult.style.display = 'block';
            }, 100);
            check = true;
        }
    });

    document.getElementById('searchForm').addEventListener('submit', function(event) {
        event.preventDefault();
        searchUser();
    });
}

function SidebarOnOff() {
    var openBtn = document.getElementById("buttonSidebar");
    var closeBtn = document.getElementById("closeSidebar");
    var sidebar = document.getElementById("sidebar");
    var check = false;

    function checkScreenSize() {
        return window.innerWidth >= 1000;
    }

    openBtn.addEventListener("click", function() {
        sidebar.style.transition="all 0.25s";
        if (checkScreenSize()) {
            return;
        }

        sidebar.style.transform = "translateX(0)";
        openBtn.style.display = "none";
        check = true;
    });

    closeBtn.addEventListener("click",function(){
        sidebar.style.transition="all 0.25s";
        if (checkScreenSize()) {
            return;
        }

        sidebar.style.transform = "translateX(-100%)";
        openBtn.style.display = "block";
        check = false;
    });

    window.addEventListener("resize", function() {
        if (checkScreenSize()) {
            sidebar.style.transform = "translateX(0)";
            sidebar.style.transition="all 0.25s";
            closeBtn.style.display="none";
        }else{
            closeBtn.style.display="block";
            sidebar.style.transition="all 0s";
            if(!check){
                sidebar.style.transform = "translateX(-100%)";
            }
        }
    });
}

function ShowProfile() {
    const profileNameWrapper = document.querySelector('.profileNameWrapper');
    const profileInfo = document.querySelector('.profileInfo');
    const profileWrapper = document.querySelector('.profileWrapper');

    profileWrapper.addEventListener('mouseenter', () => {
        profileInfo.style.display = 'block';
        profileWrapper.style.backgroundColor = 'white';
        profileWrapper.style.boxShadow = '1px 4px 4px #c4c4c4';
        profileNameWrapper.style.borderBottom='0.5px solid #d8d8d8';
    });

    profileWrapper.addEventListener('mouseleave', () => {
        profileInfo.style.display = 'none';
        profileWrapper.style.backgroundColor = '';
        profileWrapper.style.boxShadow = '';
        profileNameWrapper.style.border='';
    });
}

document.getElementById('logout').addEventListener('click', async function() {
    try {
        const response = await fetch('/logout');
        if (!response.ok) {
            throw new Error('로그아웃에 실패했습니다.');
        }

        const result = await response.json();
        if (result.success) {
            window.location.href = '/';
        } else {
            throw new Error('로그아웃에 실패했습니다.');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

var postCheck = false;

function postOnOff() {
    var postWrite = document.getElementById("postWrite");
    var groupContainer = document.getElementById("groupContainer");

    if (!postCheck) {
        postWrite.style.display = "block";
        groupContainer.style.display = "none";
        postCheck = true;
    } else {
        postWrite.style.display = "none";
        groupContainer.style.display = "block";
        postCheck = false;
    }
}

const blogBtn = document.getElementById("blogBtn");
const notionBtn = document.getElementById("notionBtn");

blogBtn.addEventListener("click", function() {
    blogBtn.classList.add("active");
    notionBtn.classList.remove("active");
});

notionBtn.addEventListener("click", function() {
    notionBtn.classList.add("active");
    blogBtn.classList.remove("active");
});

document.getElementById('reviseProfile').addEventListener('click', function() {
    window.location.href = './setting.html';
});
</script>
<script src="../src/index.js"></script>
</html>
