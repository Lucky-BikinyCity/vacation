<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그룹</title>
    <link rel="stylesheet" href="../src/index.css">
    <style>
        .active {
            filter: opacity(0.7);
        }
    </style>
</head>
<body id="groupBody">
    <header class="groupHtmlHeader">
        <img src="../imgs/web-icons/logo2-B.png" alt="Logo" class="logo logoInMain" onclick="location.href='./main.html';">
        <div class="profileWrapper">
            <div class="profileNameWrapper">
                <img src="../imgs/icon/user_circle.png" class="profileImg" alt="">
                <span id="profileName" class="profileName"></span>
            </div>
            <div class="profileInfo">
                <div class="containerInProfileInfo">
                    <img src="../imgs/icon/group-B.png" alt="">
                    <div>그룹</div>
                    <div></div>
                    <span id="group_count" class="count"></span>
                </div>

                <div class="containerInProfileInfo">
                    <img src="../imgs/icon/heart_fill.png" alt="">
                    <div>좋아요</div>
                    <div></div>
                    <span id="like_count" class="count"></span>
                </div>

                <button id="logout" class="logoutInProfile">
                    <img src="../imgs/icon/exit-b.png" alt="">
                    로그아웃
                </button>
            </div>
        </div>
    </header>

    <div class="secondGroupBody">
        <div id="sidebar" class="sidebar">
            <img id="closeSidebar" src="../imgs/icon/close.png" alt="">
            <div class="titleContainer">TITLE</div>
            <div class="memberListContainer">
                <!--자기 자신-->
                <!-- <div class="memberList myself">
                    <img src="../imgs/icon/user.png" alt="">
                    <div class="member">
                        <span id="myname">username</span>
                        <div>(나)</div>
                    </div>
                    <button id="post"><img src="../imgs/icon/post.png" alt=""></button> 
                </div> -->

                <!-- 다른 멤버-->
                <!-- <div class="memberList">
                    <img src="../imgs/icon/user.png" alt="">
                    <span id="membername" class="member">username</span>
                    <button id="kick"><img src="../imgs/icon/close.png" alt=""></button> 
                </div> -->
            </div>

            <div class="hideMemberList"></div> <!--단순히 멤버리스트 가리기 용-->
            <div class="addUserContainer">
                <!--사이드바 유저 검색 input창-->
                <div id="searchUserContainer" class="searchUserContainer">
                    <div class="inputContainer">
                        <input id="searchUser" class="searchUser" type="text" placeholder="유저 검색">
                        <button class="searchButton" onclick="searchUser()"><img src="../imgs/icon/search.png" alt=""></button>
                    </div>
                    <div class="searchResultContainer">
                        <div class="searchResult" onclick="inviteUser()">
                            <img class="searchResultImg" src="../imgs/icon/user.png" alt="">
                            <div id="searchName" class="searchName"></div>
                        </div>
                    </div>
                </div>
                <button id="addmember" class="addMember"><img src="../imgs/icon/add-user.png" alt=""></button>
            </div>
        </div>

        <button id="buttonSidebar" class="buttonSidebar"><img src="../imgs/icon/menu.png" alt=""></button>

        <!--포스트링크-->
        <div id="postWrite" class="postWrite">
            <div class="postContainer">
                <div class="postUnderline">
                    <img src="../imgs/icon/link.png" alt="">
                    <input type="text" id="embedLink" placeholder="your blog or notion link..." class="embedLink">
                </div>
                <div class="chooseLink">
                    <button id="blogBtn" class="blogBtn"><img src="../imgs/icon/blog.png" alt=""></button>
                    <button id="notionBtn" class="notionBtn"><img src="../imgs/icon/notion.png" alt=""></button>
                </div>
                <button id="submitPost" class="submitPost" type="submit">Post</button>
            </div>
        </div>

        <!--블로그나 노션 나타내는 공간-->
        <div id="groupContainer" class="groupContainer">
            <!--게시물-->
            <div class="boardContainer">
                <!--iframe-->
                <iframe class="board" src="https://www.notion.so/1ac3fd10dbde488c84035a48448bc168?pvs=4" frameborder="0"></iframe>
                <!--댓글 틀-->
                <div class="commentContainer">
                    <!--댓글 목록-->
                    <button id="delPost" class="delPost"><img src="../imgs/icon/delete.png" alt=""></button>
                    <div class="commentList">
                        <div id="comment" class="comment">
                            <div class="commentHeader">
                                <div id="commentWriter" class="commentWriter">user_name</div>
                                <div id="commentPostDate" class="commentPostDate">2024/07/18</div>
                            </div>
                            <div class="commentContent">우리 아직 안 한게 모가 있지?? 댓글 틀 만들기?? 웅 마쟈 졍답 ㅎㅎ</div>
                            <button id="delComment" class="delComment">[삭제]</button>
                        </div>
                    </div>

                    <!--댓글 입력 틀-->
                    <div class="commentFooter">
                        <!--좋아요 안눌렀으면 img heart, 좋아요 눌렀으면 img heart_fill로 된 걸로 하기-->
                        <!-- <button id="like" class="like btnCommentFooter"><img src="../imgs/icon/heart.png" alt=""></button> -->
                        <button id="like" class="like btnCommentFooter"><img src="../imgs/icon/heart_fill.png" alt=""></button>
                        <img class="commentImg imgInComment" src="../imgs/icon/comment.png" alt="">
                        <div class="commentStructure">
                            <input id="comment" class="commentInput" type="text" placeholder="댓글">
                            <button id="sendComment" class="sendComment btnCommentFooter"><img src="../imgs/icon/send.png" alt=""></button>
                        </div>
                    </div>
                </div>
            </div>
            <!--게시물-->
            <div class="boardContainer">
                <iframe class="board" src="https://www.notion.so/1ac3fd10dbde488c84035a48448bc168?pvs=4" frameborder="0"></iframe>
                <div class="commentContainer">
                    <div></div>
                    <div class="commentFooter">
                        <!--좋아요 안눌렀으면 img heart, 좋아요 눌렀으면 img heart_fill로 된 걸로 하기-->
                        <button id="like" class="like btnCommentFooter"><img src="../imgs/icon/heart.png" alt=""></button>
                        <!-- <button id="like" class="like btnCommentFooter"><img src="../imgs/icon/heart_fill.png" alt=""></button> -->
                        <img class="commentImg imgInComment" src="../imgs/icon/comment.png" alt="">
                        <div class="commentStructure">
                            <input id="comment" class="commentInput" type="text" placeholder="댓글">
                            <button id="sendComment" class="sendComment btnCommentFooter"><img src="../imgs/icon/add-user.png" alt=""></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="../src/index.js"></script>
<script>
    var postCheck = false;

    //포스트 링크 on off
    function postOnOff() {
        var postWrite = document.getElementById("postWrite");
        var groupContainer = document.getElementById("groupContainer");

        if (!postCheck) {
            postWrite.style.display = "block";
            groupContainer.style.display = "none";
            postCheck = true;
        } else {
            postWrite.style.display = "none";
            groupContainer.style.display = "block";
            postCheck = false;
        }
    }

        const blogBtn = document.getElementById("blogBtn");
        const notionBtn = document.getElementById("notionBtn");

        blogBtn.addEventListener("click", function() {
            blogBtn.classList.add("active");
            notionBtn.classList.remove("active");
        });

        notionBtn.addEventListener("click", function() {
            notionBtn.classList.add("active");
            blogBtn.classList.remove("active");
        });

    let currentUserID = '';
    let groupOwnerID = '';
    let groupID = ''; // 전역 변수로 groupID를 추가합니다.

    async function fetchGroupInfo() {
        try {
            const response = await fetch('/api/group-info');
            if (!response.ok) {
                throw new Error('Failed to fetch group info');
            }
            const data = await response.json();
            groupID = data.groupID; // groupID를 전역 변수에 저장합니다.
            renderGroupInfo(data);
        } catch (error) {
            console.error('Error fetching group info:', error);
        }
    }

    document.getElementById('logout').addEventListener('click', async function() {
            try {
                const response = await fetch('/logout');
                if (!response.ok) {
                    throw new Error('로그아웃에 실패했습니다.');
                }

                const result = await response.json();
                if (result.success) {
                    window.location.href = '/';
                } else {
                    throw new Error('로그아웃에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

    function renderGroupInfo(data) {
        const memberListContainer = document.querySelector('.memberListContainer');
        memberListContainer.innerHTML = '';

        const { currentUser, groupOwner, members } = data;
        currentUserID = currentUser.user_ID;
        groupOwnerID = groupOwner.user_ID;

        // 현재 사용자 정보 출력
        const currentUserElement = document.createElement('div');
        currentUserElement.className = 'memberList myself';
        currentUserElement.innerHTML = `
            <img src="../imgs/icon/user.png" alt="">
            <div class="member">
                <span id="myname">${currentUser.user_name}</span>
                <div>(나)</div>
            </div>
            <button id="openPost" onclick="postOnOff()"><img src="../imgs/icon/post.png" alt=""></button> <!--포스트 버튼-->
        `;
        memberListContainer.appendChild(currentUserElement);

        // 그룹장 정보 출력 (그룹장이 현재 사용자가 아닌 경우에만)
        if (currentUser.user_ID !== groupOwner.user_ID) {
            const groupOwnerElement = document.createElement('div');
            groupOwnerElement.className = 'memberList';
            groupOwnerElement.innerHTML = `
                <img src="../imgs/icon/user.png" alt="">
                <span id="membername" class="member">${groupOwner.user_name}</span>
            `;
            memberListContainer.appendChild(groupOwnerElement);
        }

        // 그룹 멤버 정보 출력
        members.forEach(member => {
            if (member.user_ID !== currentUser.user_ID && member.user_ID !== groupOwner.user_ID) {  // 현재 사용자와 그룹장은 제외
                const memberElement = document.createElement('div');
                memberElement.className = 'memberList';
                memberElement.innerHTML = `
                    <img src="../imgs/icon/user.png" alt="">
                    <span id="membername" class="member">${member.user_name}</span>
                    ${groupOwnerID === currentUserID ? `<button class="kickButton" onclick="kickUser('${member.user_ID}')"><img src="../imgs/icon/close.png" alt=""></button>` : ''}
                `;
                memberListContainer.appendChild(memberElement);
            }
        });
    }

    async function kickUser(userID) {
        try {
            const response = await fetch('/api/kick-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_ID: userID, group_ID: groupID, groupOwnerID: groupOwnerID })
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                fetchGroupInfo(); // 사용자 추방 후 그룹 정보를 다시 가져옵니다.
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function searchUser() {
        const userID = document.getElementById('searchUser').value;
        const searchName = document.getElementById('searchName');

        console.log('Searching for user:', userID); // 디버깅용 로그

        try {
            const response = await fetch('/api/search-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_ID: userID })
            });

            const result = await response.json();

            if (response.ok) {
                searchName.textContent = `${result.user_name} (${result.user_ID})`;
                document.querySelector('.searchResultContainer').style.display = 'block';
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function inviteUser() {
        const searchName = document.getElementById('searchName').textContent;
        const userID = searchName.split('(')[1].slice(0, -1);

        console.log('Inviting user:', userID); // 디버깅용 로그

        try {
            const response = await fetch('/api/invite-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_ID: userID })
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                fetchGroupInfo(); // 사용자 초대 후 그룹 정보를 다시 가져옵니다.
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // 페이지 로드 시 그룹 정보를 가져옵니다.
    window.onload = async function() {
        await fetchUserInfo(); // 사용자 정보를 먼저 가져옵니다.
        fetchGroupInfo(); // 그룹 정보를 가져옵니다.
    };

    async function fetchUserInfo() {
        try {
            const response = await fetch('/api/main');
            if (!response.ok) {
                throw new Error('사용자 정보를 가져오지 못했습니다.');
            }
            const data = await response.json();
            document.getElementById('profileName').textContent = data.user_name;
            document.getElementById('group_count').textContent = data.group_count;
            document.getElementById('like_count').textContent = data.like_count;
        } catch (error) {
            console.error('Error fetching user info:', error);
        }
    }

</script>

</html>
