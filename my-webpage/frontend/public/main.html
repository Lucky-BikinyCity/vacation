<!---->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메인</title>
    <link rel="stylesheet" href="../src/index.css">
</head>
<body id="mainBody" class="dragUnable">
    <header class="mainHtmlHeader">
        <img src="../imgs/web-icons/logo2-B.png" alt="Logo" class="logo logoInMain">
        <div class="profileWrapper">
            <div class="profileNameWrapper">
                <img src="../imgs/icon/user_circle.png" class="profileImg" alt="">
                <span id="profileName" class="profileName"></span>
            </div>
            <div class="profileInfo">
                <div class="containerInProfileInfo">
                    <img src="../imgs/icon/group-B.png" alt="">
                    <div>그룹</div>
                    <div></div>
                    <span id="group_count" class="count"></span>
                </div>

                <div class="containerInProfileInfo">
                    <img src="../imgs/icon/heart_fill.png" alt="">
                    <div>좋아요</div>
                    <div></div>
                    <span id="like_count" class="count"></span>
                </div>

                <button id="logout" class="logoutInProfile">
                    <img src="../imgs/icon/exit-b.png" alt="">
                    로그아웃
                </button>
            </div>
        </div>
    </header>
    <main class="mainHtmlMain">
        <div id="groupBoxes" class="groupBoxes" style="display: none;">
            <button id="addGroupInBoxes" class="addGroupInGroupBox" style="display: none;">
                <img src="../imgs/icon/add_circle.png" alt="Logo" class="addCircle">
                <div class="addGroupPhrase koreanFont">그룹 추가</div>
            </button>

            <div id="createGroup" class="groupBox createGroup" style="display: none;">
                <div id="imgWrapper" class="imgWrapper">
                    <img class="logo" src="../imgs/web-icons/logo1-B.png" alt="">
                </div>
                <div id="groupSetting" class="groupSetting">
                    <div class="groupInfo">
                        <div class="namingGroup">
                            <input id="input_group_name" type="text" placeholder="group name">
                        </div>
                        <div class="numberingMember">
                            <img src="../imgs/icon/group.png" alt="">
                            <span>member</span>
                            <div class="member-count-container">
                                <button class="minus" onclick="handleMemberCount(-1)">-</button>
                                <input type="number" id="input_member_number" value="2" min="2" />
                                <button class="plus" onclick="handleMemberCount(1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="buttonWrapper">
                        <button class="koreanFont" id="add-button">추가</button>
                    </div>
                </div>
            </div>
        </div>

        <button id="addGroupOnMain" class="addGroup" style="display: none;">
            <img src="../imgs/icon/add_circle.png" alt="Logo" class="addCircle">
            <div class="addGroupPhrase koreanFont">그룹 추가</div>
        </button>

        
    </main>
    <script src="../src/index.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
    try {
        // 사용자 정보 가져오기
        const userInfoResponse = await fetch('/api/main');
        console.log('User info response:', userInfoResponse);  // 응답 로그

        if (!userInfoResponse.ok) {
            throw new Error('사용자 정보를 가져오지 못했습니다.');
        }

        const userInfo = await userInfoResponse.json();
        console.log('User info data:', userInfo);  // 사용자 정보 로그

        const userId = userInfo.user_id;  // 사용자 ID
        document.getElementById('profileName').textContent = userInfo.user_name;
        document.getElementById('group_count').textContent = userInfo.group_count;
        document.getElementById('like_count').textContent = userInfo.like_count;

        // 그룹 정보 가져오기
        const groupResponse = await fetch('/api/user-groups');
        console.log('Group response:', groupResponse);  // 응답 로그

        if (!groupResponse.ok) {
            throw new Error('그룹 정보를 가져오지 못했습니다.');
        }

        const groupData = await groupResponse.json();
        console.log('Group data:', groupData);  // 그룹 정보 로그

        const groupBoxes = document.getElementById('groupBoxes');

        if (groupData.groups.length > 0) {
            // 그룹이 있을 때
            groupData.groups.forEach(group => {
                console.log('Group:', group);  // 각 그룹 정보 로그

                const groupBox = document.createElement('a');
                groupBox.href = '../public/group.html';
                groupBox.className = 'groupBox existGroup';

                        groupBox.innerHTML = `
                            <div class="imgWrapper">
                                <img class="thumbnail" src="" alt="" onerror="this.style.display='none'">
                                <img class="logo" src="../imgs/web-icons/logo1-B.png" alt="">
                            </div>
                            <div class="groupInfoContainer">
                                <div class="groupInfo">
                                    <div class="namingGroup koreanFont">${group.group_name} / ${group.group_king}</div>
                                    <div class="numberingMember">
                                        <img src="../imgs/icon/group.png" alt="">
                                        <span class="count">${group.current_members} / ${group.max_members}</span>
                                    </div>
                                </div>
                                <div class="buttonWrapper">
                                    <button class="koreanFont" id="delGroup">
                                        <img src="../imgs/icon/exit.png" alt="">
                                    </button>
                                    <button class="koreanFont" id="exitGroup">
                                        <img src="../imgs/icon/delete.png" alt="">
                                    </button>
                                </div>
                            </div>
                        `;

                groupBoxes.appendChild(groupBox);
            });
            document.getElementById('groupBoxes').style.display = 'flex';
            document.getElementById('addGroupInBoxes').style.display = 'block';

            // 그룹 삭제 및 탈퇴 버튼 이벤트 추가
            document.querySelectorAll('.delGroup').forEach(button => {
                button.addEventListener('click', async function(event) {
                    const groupId = event.currentTarget.getAttribute('data-group-id');
                    try {
                        const response = await fetch(`/api/delete-group/${groupId}`, { method: 'DELETE' });
                        if (response.ok) {
                            alert('그룹이 삭제되었습니다.');
                            window.location.reload(); // 페이지 새로고침
                        } else {
                            alert('그룹 삭제에 실패했습니다.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('그룹 삭제 중 오류가 발생했습니다.');
                    }
                });
            });

            document.querySelectorAll('.exitGroup').forEach(button => {
                button.addEventListener('click', async function(event) {
                    const groupId = event.currentTarget.getAttribute('data-group-id');
                    try {
                        const response = await fetch(`/api/exit-group/${groupId}`, { method: 'POST' });
                        if (response.ok) {
                            alert('그룹에서 탈퇴하였습니다.');
                            window.location.reload(); // 페이지 새로고침
                        } else {
                            alert('그룹 탈퇴에 실패했습니다.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('그룹 탈퇴 중 오류가 발생했습니다.');
                    }
                });
            });
        } else {
            // 그룹이 없을 때
            document.getElementById('addGroupOnMain').style.display = 'block';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('정보를 가져오는 중 오류가 발생했습니다.');
    }
});
        // 로그아웃 버튼 클릭 시 로그아웃 처리
        document.getElementById('logout').addEventListener('click', async function() {
            try {
                const response = await fetch('/logout');
                console.log('Logout response:', response);  // 응답 로그

                if (!response.ok) {
                    throw new Error('로그아웃에 실패했습니다.');
                }

                const result = await response.json();
                console.log('Logout result:', result);  // 로그아웃 결과 로그

                if (result.success) {
                    window.location.href = '/';
                } else {
                    throw new Error('로그아웃에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // 그룹 추가 버튼 클릭 시 createGroup 표시
        document.getElementById('addGroupOnMain').addEventListener('click', function() {
            document.getElementById('createGroup').style.display = 'block';
            this.style.display = 'none';
        });

        document.getElementById('addGroupInBoxes').addEventListener('click', function() {
            document.getElementById('createGroup').style.display = 'block';
            this.style.display = 'none';
        });

        // 멤버 수 조절 버튼 기능
        function handleMemberCount(change) {
            const input = document.getElementById('input_member_number');
            if (input) {
                const currentValue = parseInt(input.value);
                const newValue = currentValue + change;
                if (newValue >= 2) {
                    input.value = newValue;
                }
            }
        }

        // 그룹 추가 버튼 클릭 시 입력 값을 서버로 전송
        document.getElementById('add-button').addEventListener('click', async function() {
            const groupNameElement = document.getElementById('input_group_name');
            const maxMembersElement = document.getElementById('input_member_number');

            if (!groupNameElement || !maxMembersElement) {
                console.error('Element not found');
                return;
            }

            const groupName = groupNameElement.value;
            const maxMembers = maxMembersElement.value;

            if (!groupName || !maxMembers) {
                alert('모든 필드를 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/create-group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ groupName, maxMembers })
                });
                console.log('Create group response:', response);  // 응답 로그

                if (response.ok) {
                    alert('그룹이 생성되었습니다.');
                    window.location.reload(); // 페이지 새로고침
                } else {
                    const result = await response.json();
                    console.log('Create group result:', result);  // 결과 로그
                    alert(result.message || '그룹 생성에 실패했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('그룹 생성 중 오류가 발생했습니다.');
            }
        });

        function preventLink(event) {
            event.preventDefault();

            //여기에 삭제나 그룹탈퇴 버튼 기능 작성
        }
    </script>
</body>
</html>
